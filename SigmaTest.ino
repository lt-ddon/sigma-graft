#include <stdint.h>
#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/delay.h>/*;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;*/

uint8_t ROMIndex;

uint8_t ROMData[] = {
  0x81, 0x94, 0x0a, 0x00, 0x84, 0x08, 0x08, 0x82, 0xcc, 0x00, 0xfb, 0xca, 0x00, 0x00, 0x00, 0xce,
  0x00, 0xce, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xcf, 0x63,
};

const uint8_t focusData[16][4] = {
  {0x00, 0x82, 0xca, 0xce}, /* 0 */
  {0x00, 0x42, 0x8a, 0xce}, /* 1 */
  {0x00, 0xa2, 0x52, 0xae}, /* 3 */
  {0x00, 0xc2, 0xb2, 0x2e}, /* 2 */
  {0x40, 0x32, 0xbc, 0x81}, /* 7 */
  {0x80, 0x52, 0x02, 0x7e}, /* 6 */
  {0x00, 0xe2, 0xe2, 0xee}, /* 4 */
  {0x80, 0x12, 0x22, 0x5e}, /* 5 */
  {0xe0, 0x9a, 0xf8, 0xad}, /* F */
  {0x60, 0xea, 0x44, 0x35}, /* E */
  {0xa0, 0x2a, 0x94, 0x79}, /* C */
  {0x60, 0xaa, 0x64, 0x25}, /* D */
  {0x40, 0xb2, 0x9c, 0xa1}, /* 8 */
  {0xc0, 0xf2, 0xac, 0xd1}, /* 9 */
  {0x20, 0x4a, 0xf4, 0xa9}, /* B */
  {0x20, 0x8a, 0x4c, 0x09}, /* A */
};

ISR (USI_OVF_vect)
{
  USIDR = ROMData[ROMIndex];
  ROMIndex++;
  if (ROMIndex >= 32) ROMIndex = 0;
  USISR = 0x40;
}

ISR (EXT_INT0_vect)
{
  if (!(PINB & 0x04))
  {
    uint8_t a = PINA & 0x0f;
    ROMData[0x03] = focusData[a][0];
    ROMData[0x07] = focusData[a][1];
    ROMData[0x0b] = focusData[a][2];
    ROMData[0x0f] = focusData[a][3];
    ROMIndex = 0;
    USIDR   = 0xff;
    USISR   = 0xf0;
    USICR   = 0x5c;
  }
  else
  {
    USICR   = 0x00;
  }
}

int main()
{
  cli();
  DDRA    = 0x20;
  MCUCR   = 0x01;
  GIMSK   = 0x40;
  sei();
  
  while (true)
  {

  }
}
